<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Microphone volume detect</title>
</head>
<body>

</body>
<p id="audio-value"></p>
<p id="is-speaking"></p>
<script>
    var audioContext = new (window.AudioContext || window.webkitAudioContext)()
    var mediaStreamSource = null
    var meter = null
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({audio: true}).then((stream) => {
            mediaStreamSource = audioContext.createMediaStreamSource(stream)
            meter = createAudioMeter(audioContext)
            mediaStreamSource.connect(meter)
        })
    }

    function createAudioMeter(audioContext, clipLevel, averaging, clipLag) {
        const processor = audioContext.createScriptProcessor(512)
        processor.onaudioprocess = volumeAudioProcess
        processor.clipping = false
        processor.lastClip = 0
        processor.volume = 0
        processor.clipLevel = clipLevel || 0.98
        processor.averaging = averaging || 0.95
        processor.clipLag = clipLag || 750
        processor.connect(audioContext.destination)
        processor.checkClipping = function () {
            if (!this.clipping) {
                return false
            }
            if ((this.lastClip + this.clipLag) < window.performance.now()) {
                this.clipping = false
            }
            return this.clipping
        }

        processor.shutdown = function () {
            this.disconnect()
            this.onaudioprocess = null
        }

        return processor
    }

    function volumeAudioProcess(event) {
        const buf = event.inputBuffer.getChannelData(0)
        const bufLength = buf.length
        let sum = 0
        let x
        for (var i = 0; i < bufLength; i++) {
            x = buf[i]
            if (Math.abs(x) >= this.clipLevel) {
                this.clipping = true
                this.lastClip = window.performance.now()
            }
            sum += x * x
        }
        const rms = Math.sqrt(sum / bufLength)
        this.volume = Math.max(rms, this.volume * this.averaging).toFixed(2)

        document.getElementById('audio-value').innerHTML = this.volume
        if (this.volume > 0.1) {
            document.getElementById('is-speaking').innerText = "SPEAKING";
        } else {
            document.getElementById('is-speaking').innerText = "";
        }
    }


</script>
</html>